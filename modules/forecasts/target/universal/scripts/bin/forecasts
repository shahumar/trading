#!/bin/sh

realpath () {
(
  TARGET_FILE="$1"

  cd "$(dirname "$TARGET_FILE")"
  TARGET_FILE=$(basename "$TARGET_FILE")

  COUNT=0
  while [ -L "$TARGET_FILE" -a $COUNT -lt 100 ]
  do
      TARGET_FILE=$(readlink "$TARGET_FILE")
      cd "$(dirname "$TARGET_FILE")"
      TARGET_FILE=$(basename "$TARGET_FILE")
      COUNT=$(($COUNT + 1))
  done

  if [ "$TARGET_FILE" = "." -o "$TARGET_FILE" = ".." ]; then
    cd "$TARGET_FILE"
  fi
  TARGET_DIR="$(pwd -P)"
  if [ "$TARGET_DIR" = "/" ]; then
    TARGET_FILE="/$TARGET_FILE"
  else
    TARGET_FILE="$TARGET_DIR/$TARGET_FILE"
  fi
  echo "$TARGET_FILE"
)
}

# Allow user and template_declares (see below) to add java options.
addJava () {
  java_opts="$java_opts $1"
}

addApp () {
  app_commands="$app_commands $1"
}

addResidual () {
  residual_args="$residual_args \"$1\""
}

# Allow user to specify java options. These get listed first per bash-template.
if [ -n "$JAVA_OPTS" ]
then
  addJava "$JAVA_OPTS"
fi

# Loads a configuration file full of default command line options for this script.
loadConfigFile() {
  cat "$1" | sed '/^\#/d;s/\r$//' | sed 's/^-J-X/-X/' | tr '\r\n' ' '
}

# Detect which JVM we should use.
get_java_cmd() {
  # High-priority override for Jlink images
  if [ -n "$bundled_jvm" ];  then
    echo "$bundled_jvm/bin/java"
  elif [ -n "$JAVA_HOME" ] && [ -x "$JAVA_HOME/bin/java" ];  then
    echo "$JAVA_HOME/bin/java"
  else
    echo "java"
  fi
}

# Processes incoming arguments and places them in appropriate global variables.  called by the run method.
process_args () {
  local no_more_snp_opts=0
  while [ $# -gt 0 ]; do
    case "$1" in
             --) shift && no_more_snp_opts=1 && break ;;
       -h|-help) usage; exit 1 ;;
    -v|-verbose) verbose=1 && shift ;;
      -d|-debug) debug=1 && shift ;;

    -no-version-check) no_version_check=1 && shift ;;

           -mem) echo "!! WARNING !! -mem option is ignored. Please use -J-Xmx and -J-Xms" && shift 2 ;;
     -jvm-debug) require_arg port "$1" "$2" && addDebugger $2 && shift 2 ;;

          -main) custom_mainclass="$2" && shift 2 ;;

     -java-home) require_arg path "$1" "$2" && jre=`eval echo $2` && java_cmd="$jre/bin/java" && shift 2 ;;

 -D*|-agentlib*|-agentpath*|-javaagent*|-XX*) addJava "$1" && shift ;;
                                         -J*) addJava "${1:2}" && shift ;;
                                           *) addResidual "$1" && shift ;;
    esac
  done

  if [ $no_more_snp_opts ]; then
    while [ $# -gt 0 ]; do
      addResidual "$1" && shift
    done
  fi
}

app_commands=""
residual_args=""
real_script_path="$(realpath "$0")"
app_home="$(realpath "$(dirname "$real_script_path")")"
lib_dir="$(realpath "${app_home}/../lib")"

app_mainclass=trading.forecasts.Main

script_conf_file="${app_home}/../conf/application.ini"
app_classpath="$lib_dir/dev.zea.forecasts-0.1.0.jar:$lib_dir/dev.zea.core-0.1.0.jar:$lib_dir/dev.zea.lib-0.1.0.jar:$lib_dir/dev.zea.domain-0.1.0.jar:$lib_dir/org.scala-lang.scala3-library_3-3.4.1.jar:$lib_dir/org.typelevel.cats-core_3-2.10.0.jar:$lib_dir/org.typelevel.cats-effect_3-3.5.4.jar:$lib_dir/io.circe.circe-core_3-0.14.6.jar:$lib_dir/io.circe.circe-parser_3-0.14.6.jar:$lib_dir/is.cir.ciris_3-3.2.0.jar:$lib_dir/is.cir.ciris-refined_3-3.2.0.jar:$lib_dir/co.fs2.fs2-core_3-3.9.4.jar:$lib_dir/org.typelevel.kittens_3-3.3.0.jar:$lib_dir/com.comcast.ip4s-core_3-3.5.0.jar:$lib_dir/org.typelevel.log4cats-noop_3-2.7.0.jar:$lib_dir/dev.optics.monocle-core_3-3.2.0.jar:$lib_dir/org.tpolecat.doobie-h2_3-1.0.0-RC4.jar:$lib_dir/org.flywaydb.flyway-core-8.5.13.jar:$lib_dir/org.scala-lang.scala-library-2.13.12.jar:$lib_dir/org.typelevel.cats-kernel_3-2.10.0.jar:$lib_dir/org.typelevel.cats-effect-kernel_3-3.5.4.jar:$lib_dir/org.typelevel.cats-effect-std_3-3.5.4.jar:$lib_dir/io.circe.circe-numbers_3-0.14.6.jar:$lib_dir/io.circe.circe-jawn_3-0.14.6.jar:$lib_dir/eu.timepit.refined_3-0.10.3.jar:$lib_dir/org.scodec.scodec-bits_3-1.1.38.jar:$lib_dir/org.typelevel.alleycats-core_3-2.10.0.jar:$lib_dir/org.typelevel.shapeless3-deriving_3-3.4.1.jar:$lib_dir/org.typelevel.literally_3-1.2.0.jar:$lib_dir/org.typelevel.log4cats-core_3-2.7.0.jar:$lib_dir/org.typelevel.cats-free_3-2.9.0.jar:$lib_dir/org.tpolecat.doobie-core_3-1.0.0-RC4.jar:$lib_dir/com.h2database.h2-1.4.200.jar:$lib_dir/org.typelevel.jawn-parser_3-1.4.0.jar:$lib_dir/com.chuusai.shapeless_2.13-2.3.10.jar:$lib_dir/org.tpolecat.doobie-free_3-1.0.0-RC4.jar:$lib_dir/org.tpolecat.typename_3-1.1.0.jar:$lib_dir/com.github.fd4s.fs2-kafka_3-3.4.0.jar:$lib_dir/org.http4s.http4s-dsl_3-1.0.0-M41.jar:$lib_dir/org.http4s.http4s-prometheus-metrics_3-1.0.0-M38.jar:$lib_dir/org.http4s.http4s-ember-server_3-1.0.0-M41.jar:$lib_dir/io.github.iltotore.iron-cats_3-2.6.0.jar:$lib_dir/io.github.iltotore.iron_3-2.6.0.jar:$lib_dir/io.github.iltotore.iron-circe_3-2.6.0.jar:$lib_dir/dev.profunktor.neutron-core_3-0.8.0.jar:$lib_dir/com.github.valskalla.odin-core_3-0.13.0.jar:$lib_dir/dev.profunktor.redis4cats-effects_3-1.7.1.jar:$lib_dir/org.apache.kafka.kafka-clients-3.7.0.jar:$lib_dir/org.http4s.http4s-core_3-1.0.0-M41.jar:$lib_dir/io.prometheus.simpleclient-0.16.0.jar:$lib_dir/io.prometheus.simpleclient_common-0.16.0.jar:$lib_dir/io.prometheus.simpleclient_hotspot-0.16.0.jar:$lib_dir/org.http4s.http4s-ember-core_3-1.0.0-M41.jar:$lib_dir/org.http4s.http4s-server_3-1.0.0-M41.jar:$lib_dir/org.apache.pulsar.pulsar-client-3.1.0.jar:$lib_dir/org.typelevel.cats-mtl_3-1.2.1.jar:$lib_dir/com.lihaoyi.sourcecode_3-0.2.7.jar:$lib_dir/com.outr.perfolation_3-1.2.8.jar:$lib_dir/dev.profunktor.redis4cats-core_3-1.7.1.jar:$lib_dir/io.lettuce.lettuce-core-6.3.2.RELEASE.jar:$lib_dir/com.github.luben.zstd-jni-1.5.5-6.jar:$lib_dir/org.lz4.lz4-java-1.8.0.jar:$lib_dir/org.xerial.snappy.snappy-java-1.1.10.5.jar:$lib_dir/org.slf4j.slf4j-api-1.7.36.jar:$lib_dir/org.typelevel.case-insensitive_3-1.4.0.jar:$lib_dir/org.typelevel.cats-parse_3-1.0.0.jar:$lib_dir/co.fs2.fs2-io_3-3.9.4.jar:$lib_dir/org.typelevel.vault_3-3.5.0.jar:$lib_dir/io.prometheus.simpleclient_tracer_otel-0.16.0.jar:$lib_dir/io.prometheus.simpleclient_tracer_otel_agent-0.16.0.jar:$lib_dir/com.twitter.hpack-1.0.2.jar:$lib_dir/org.http4s.http4s-crypto_3-0.2.4.jar:$lib_dir/org.apache.pulsar.pulsar-client-api-3.1.0.jar:$lib_dir/org.apache.pulsar.pulsar-client-admin-api-3.1.0.jar:$lib_dir/javax.ws.rs.javax.ws.rs-api-2.1.jar:$lib_dir/com.google.protobuf.protobuf-java-3.19.6.jar:$lib_dir/org.apache.pulsar.bouncy-castle-bc-3.1.0-pkg.jar:$lib_dir/org.bouncycastle.bcpkix-jdk18on-1.75.jar:$lib_dir/org.bouncycastle.bcprov-jdk18on-1.75.jar:$lib_dir/org.bouncycastle.bcutil-jdk18on-1.75.jar:$lib_dir/org.bouncycastle.bcprov-ext-jdk18on-1.75.jar:$lib_dir/com.sun.activation.javax.activation-1.2.0.jar:$lib_dir/com.fasterxml.jackson.core.jackson-annotations-2.14.2.jar:$lib_dir/javax.validation.validation-api-1.1.0.Final.jar:$lib_dir/net.jcip.jcip-annotations-1.0.jar:$lib_dir/io.netty.netty-common-4.1.107.Final.jar:$lib_dir/io.netty.netty-handler-4.1.107.Final.jar:$lib_dir/io.netty.netty-transport-4.1.107.Final.jar:$lib_dir/io.projectreactor.reactor-core-3.6.4.jar:$lib_dir/io.prometheus.simpleclient_tracer_common-0.16.0.jar:$lib_dir/io.netty.netty-resolver-4.1.107.Final.jar:$lib_dir/io.netty.netty-buffer-4.1.107.Final.jar:$lib_dir/io.netty.netty-transport-native-unix-common-4.1.107.Final.jar:$lib_dir/io.netty.netty-codec-4.1.107.Final.jar:$lib_dir/org.reactivestreams.reactive-streams-1.0.4.jar"


process_args "$@"

# Fallback to custom mainclass if main class is not provided (this is the case if the JAR contains multiple apps)
if [ "$app_mainclass" = "" ] || [ $custom_mainclass ];then
  if [ "$custom_mainclass" = "" ]; then
    echo "You need to pass -main argument."
    exit 1
  fi

  app_mainclass=$custom_mainclass
fi

java_cmd="$(get_java_cmd)"

# If a configuration file exist, read the contents to $opts
[ -f "$script_conf_file" ] && opts=$(loadConfigFile "$script_conf_file")

eval "exec $java_cmd $java_opts -classpath $app_classpath $opts $app_mainclass $app_commands $residual_args"
